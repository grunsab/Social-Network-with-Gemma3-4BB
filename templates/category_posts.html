{% extends "base.html" %}

{% block title %}Posts in Category: {{ category_name }}{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <h1 class="mb-4">Posts in Category: <span class="badge bg-primary">{{ category_name }}</span></h1>

        {# Display flash messages if any #}
        {% with messages = get_flashed_messages(with_categories=true) %}
          {% if messages %}
            {% for category, message in messages %}
              <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
              </div>
            {% endfor %}
          {% endif %}
        {% endwith %}

        {% if posts %}
            {% for post in posts %}
                {# Reuse the same card structure as index.html for consistency #}
                <div class="card post-card shadow-sm mb-3">
                    <div class="card-body">
                        <h5 class="card-title">
                           <a href="{{ url_for('profile', username=post.author.username) }}" class="text-decoration-none">@{{ post.author.username }}</a>
                           {% if post.privacy.name == 'FRIENDS' %}
                               <span class="badge bg-info ms-2"><i class="bi bi-people-fill"></i> Friends Only</span>
                           {% else %}
                               <span class="badge bg-secondary ms-2"><i class="bi bi-globe"></i> Public</span>
                           {% endif %}
                        </h5>

                        {# Display Image if it exists #}
                        {% if post.image_url %}
                            <img src="{{ post.image_url }}" class="img-fluid rounded mb-2" alt="Post image">
                        {% endif %}

                        {# Wrap post content #}
                        {% if post.content %}
                            <div class="post-content mb-2" data-raw-content="{{ post.content|e }}">
                                {# Content rendered by JS #}
                            </div>
                        {% endif %}

                        <p class="card-text">
                            <small class="text-muted"><span class="local-timestamp" data-timestamp="{{ post.timestamp.isoformat() }}"></span></small>
                        </p>

                        {# Categories Section #}
                        {% if post.category_scores %}
                            <div class="mb-2">
                                {% for score in post.category_scores|sort(attribute='score', reverse=True) %}
                                    {% set category_url = url_for('category_posts', category_name=score.category) %}
                                    {# Highlight the current category, but still make it a link #}
                                    {% if score.category == category_name %}
                                        <a href="{{ category_url }}" class="text-decoration-none">
                                            <span class="badge bg-primary me-1">{{ score.category }} ({{ '%0.2f'|format(score.score) }})</span>
                                        </a>
                                    {% else %}
                                        <a href="{{ category_url }}" class="text-decoration-none">
                                            <span class="badge bg-secondary me-1">{{ score.category }} ({{ '%0.2f'|format(score.score) }})</span>
                                        </a>
                                    {% endif %}
                                {% endfor %}
                            </div>
                        {% endif %}

                        {# Buttons Section #}
                        <div class="d-flex flex-column align-items-start mt-2">
                             <div class="mb-2"> {# Wrapper for comments button/link #}
                                <button class="btn btn-sm btn-outline-primary comments-toggle" data-post-id="{{ post.id }}">
                                    Comments <span class="comment-count">{% if post.comments|length > 0 %}({{ post.comments|length }}){% endif %}</span>
                                </button>
                                <a href="{{ url_for('comments', post_id=post.id) }}" class="btn btn-sm btn-link">View All</a>
                            </div>

                            {# Delete Button/Form #}
                            {% if post.author == current_user %}
                                <div> {# Wrapper for delete button #}
                                    <form action="{{ url_for('delete_post', post_id=post.id) }}" method="POST" style="display: inline;" onsubmit="return confirm('Are you sure you want to delete this post?');">
                                        <input type="hidden" name="_method" value="DELETE">
                                        <button type="submit" class="btn btn-danger btn-sm">Delete</button>
                                    </form>
                                </div>
                            {% endif %}
                        </div>

                        <!-- Comments section (hidden by default) -->
                        <div class="comments-section mt-3 border-top pt-3" id="comments-section-{{ post.id }}" style="display: none;">
                            <div class="comments-container" id="comments-container-{{ post.id }}">
                                <div class="text-center">
                                    <div class="spinner-border spinner-border-sm" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                </div>
                            </div>
                            <!-- Comment form -->
                            <form class="comment-form mt-3" data-post-id="{{ post.id }}">
                                <div class="input-group">
                                    <input type="text" class="form-control comment-input" placeholder="Add a comment...">
                                    <button class="btn btn-primary" type="submit">Post</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            {% endfor %}
        {% else %}
            <div class="alert alert-info" role="alert">
                No posts found in the category "{{ category_name }}". <a href="{{ url_for('index') }}" class="alert-link">Return to Home</a>.
            </div>
        {% endif %}
    </div>
</div>

{# Reuse the same JavaScript block from index.html for consistency #}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Render markdown for post content
    const postContents = document.querySelectorAll('.post-content');
    postContents.forEach(div => {
      const rawContent = div.getAttribute('data-raw-content');
      if (rawContent) {
        marked.setOptions({ breaks: true });
        div.innerHTML = marked.parse(rawContent);
      }
    });

    // Handle comments toggle and AJAX loading
    const commentToggles = document.querySelectorAll('.comments-toggle');
    commentToggles.forEach(button => {
      button.addEventListener('click', function() {
        const postId = this.getAttribute('data-post-id');
        const commentsSection = document.getElementById(`comments-section-${postId}`);
        const commentsContainer = document.getElementById(`comments-container-${postId}`);

        if (commentsSection.style.display === 'none') {
          commentsSection.style.display = 'block';
          fetch(`/post/${postId}/comments`, { headers: { 'X-Requested-With': 'XMLHttpRequest' } })
            .then(response => response.json())
            .then(comments => {
              let commentsHtml = '';
              if (comments.length === 0) {
                commentsHtml = '<div class="alert alert-info">No comments yet.</div>';
              } else {
                commentsHtml = '<div class="list-group">';
                comments.forEach(comment => {
                  commentsHtml += `
                    <div class="list-group-item list-group-item-action flex-column align-items-start comment-item" id="comment-${comment.id}">
                      <div class="d-flex w-100 justify-content-between">
                        <h6 class="mb-1">@${comment.author}</h6>
                        <small class="text-muted"><span class="local-timestamp" data-timestamp="${comment.timestamp}">Loading...</span></small>
                      </div>
                      <p class="mb-1">${escapeHtml(comment.content)}</p> <!-- Escape content -->
                      ${comment.is_author ?
                        `<div class="text-end mt-1">
                          <button class="btn btn-sm btn-danger delete-comment" data-comment-id="${comment.id}">Delete</button>
                         </div>` : ''}
                    </div>
                  `;
                });
                commentsHtml += '</div>';
              }
              commentsContainer.innerHTML = commentsHtml;
              formatLocalTimestamps(); // Format timestamps after loading
              addDeleteCommentListeners(); // Add listeners for delete buttons
            })
            .catch(error => {
              console.error('Error loading comments:', error);
              commentsContainer.innerHTML = '<div class="alert alert-danger">Error loading comments</div>';
            });
        } else {
          commentsSection.style.display = 'none';
        }
      });
    });

    // Handle comment form submission
    const commentForms = document.querySelectorAll('.comment-form');
    commentForms.forEach(form => {
      form.addEventListener('submit', function(e) {
        e.preventDefault();
        const postId = this.getAttribute('data-post-id');
        const input = this.querySelector('.comment-input');
        const content = input.value.trim();
        if (content) {
          addComment(postId, content, this);
          input.value = '';
        }
      });
    });

    // Function to add a comment via AJAX
    function addComment(postId, content, form) {
      const commentsContainer = document.getElementById(`comments-container-${postId}`);
      const commentCountSpan = document.querySelector(`.comments-toggle[data-post-id="${postId}"] .comment-count`);

      fetch(`/post/${postId}/comments`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
          'X-Requested-With': 'XMLHttpRequest'
        },
        body: `content=${encodeURIComponent(content)}`
      })
      .then(response => response.json())
      .then(comment => {
        const noCommentsMsg = commentsContainer.querySelector('.alert-info');
        if (noCommentsMsg) {
          noCommentsMsg.remove();
          commentsContainer.innerHTML = '<div class="list-group"></div>';
        }
        if (!commentsContainer.querySelector('.list-group')) {
          commentsContainer.innerHTML = '<div class="list-group"></div>';
        }

        const listGroup = commentsContainer.querySelector('.list-group');
        const commentElement = document.createElement('div');
        commentElement.className = 'list-group-item list-group-item-action flex-column align-items-start comment-item';
        commentElement.id = `comment-${comment.id}`;
        commentElement.innerHTML = `
          <div class="d-flex w-100 justify-content-between">
            <h6 class="mb-1">@${comment.author}</h6>
            <small class="text-muted"><span class="local-timestamp" data-timestamp="${comment.timestamp}"></span></small>
          </div>
          <p class="mb-1">${escapeHtml(comment.content)}</p> <!-- Escape content -->
          <div class="text-end mt-1">
            <button class="btn btn-sm btn-danger delete-comment" data-comment-id="${comment.id}">Delete</button>
          </div>
        `;
        listGroup.appendChild(commentElement);
        formatLocalTimestamps(); // Update timestamp
        addDeleteCommentListeners(); // Add listener for the new delete button

        // Update comment count
        let count = parseInt(commentCountSpan.textContent.replace(/[\(\)]/g, '')) || 0;
        commentCountSpan.textContent = `(${count + 1})`;

      })
      .catch(error => console.error('Error adding comment:', error));
    }

    // Function to delete a comment via AJAX
    function deleteComment(commentId) {
        fetch(`/comment/${commentId}/delete`, {
            method: 'POST',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                // Include CSRF token if needed
            }
        })
        .then(response => {
            if (response.ok) {
                const commentElement = document.getElementById(`comment-${commentId}`);
                if (commentElement) {
                    const postCard = commentElement.closest('.post-card');
                    commentElement.remove();
                    // Optionally update comment count if needed
                    if (postCard) {
                        const postId = postCard.querySelector('.comments-toggle').getAttribute('data-post-id');
                        const commentCountSpan = postCard.querySelector(`.comments-toggle[data-post-id="${postId}"] .comment-count`);
                        // Fetch updated count or decrement locally (simpler)
                         let count = parseInt(commentCountSpan.textContent.replace(/[\(\)]/g, '')) || 1;
                         if (count > 1) {
                             commentCountSpan.textContent = `(${count - 1})`;
                         } else {
                              commentCountSpan.textContent = ''; // Remove count if zero
                              // Add back the "no comments" message if the list is now empty
                              const commentsContainer = document.getElementById(`comments-container-${postId}`);
                              if (commentsContainer && !commentsContainer.querySelector('.comment-item')) {
                                   commentsContainer.innerHTML = '<div class="alert alert-info">No comments yet.</div>';
                              }
                         }
                    }
                }
            } else {
                console.error('Failed to delete comment');
                // Handle error (e.g., show a message)
            }
        })
        .catch(error => console.error('Error deleting comment:', error));
    }

    // Helper function to add delete listeners (avoids repetition)
    function addDeleteCommentListeners() {
        document.querySelectorAll('.delete-comment').forEach(button => {
            // Prevent adding multiple listeners to the same button
            if (!button.hasAttribute('data-listener-added')) {
                button.addEventListener('click', function() {
                    const commentId = this.getAttribute('data-comment-id');
                    if (confirm('Are you sure you want to delete this comment?')) {
                        deleteComment(commentId);
                    }
                });
                button.setAttribute('data-listener-added', 'true');
            }
        });
    }

    // Helper function to escape HTML
    function escapeHtml(unsafe) {
        return unsafe
             .replace(/&/g, "&amp;")
             .replace(/</g, "&lt;")
             .replace(/>/g, "&gt;")
             .replace(/"/g, "&quot;")
             .replace(/'/g, "&#039;");
     }

    // Initial calls
    addDeleteCommentListeners(); // Add listeners for initially loaded delete buttons if any (though unlikely here)

  });
</script>
{% endblock %} 