{% extends "base.html" %}

{% block title %}Personalized Feed{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2>Your Personalized Feed</h2>

    {% if interests %}
    <div class="alert alert-info" role="alert">
        <h5 class="alert-heading">Based on your interests:</h5>
        <p>{{ interests | join(', ') }}</p>
    </div>
    {% else %}
    <div class="alert alert-secondary" role="alert">
        No specific interests found yet. Showing recent posts. Like posts to personalize your feed!
    </div>
    {% endif %}

    <hr>

    {% if posts %}
        {% for post in posts %}
            <div class="card post-card shadow-sm mb-3">
                <div class="card-body">
                    <h5 class="card-title">
                        <a href="{{ url_for('profile', username=post.author.username) }}" class="text-decoration-none">@{{ post.author.username }}</a>
                        {% if post.privacy == PostPrivacy.FRIENDS %}
                            <span class="badge bg-info ms-2"><i class="bi bi-people-fill"></i> Friends Only</span>
                        {% elif post.privacy == PostPrivacy.PUBLIC %}
                            <span class="badge bg-secondary ms-2"><i class="bi bi-globe"></i> Public</span>
                        {% else %}
                            <span class="badge bg-dark ms-2">{{ post.privacy.name|title }}</span>
                        {% endif %}
                    </h5>
                     {% if post.image_url %}
                        <img src="{{ post.image_url }}" class="img-fluid rounded mb-2" alt="Post image" style="max-height: 400px; object-fit: cover;">
                    {% endif %}
                    {% if post.content %}
                        <div class="post-content mb-2" data-raw-content="{{ post.content|e }}">
                            <!-- Content will be rendered here by JavaScript -->
                        </div>
                    {% endif %}
                    <p class="card-text">
                        <small class="text-muted"><span class="local-timestamp" data-timestamp="{{ post.timestamp.isoformat() }}"></span></small>
                    </p>
                    {% if post.category_scores or post.classification_scores %}
                        <div class="mb-2">
                            {% set scores_to_display = post.category_scores or post.classification_scores %}
                            {% for score in scores_to_display|sort(attribute='score', reverse=True) %}
                                <span class="badge bg-secondary me-1">{{ score.category }} ({{ '%0.2f'|format(score.score) }})</span>
                            {% endfor %}
                        </div>
                    {% endif %}
                    <div class="d-flex flex-column align-items-start mt-2">
                        <div class="mb-2">
                            <button class="btn btn-sm btn-outline-primary comments-toggle" data-post-id="{{ post.id }}">
                                Comments <span class="comment-count">{# JS will update count #}</span>
                            </button>
                        </div>
                        {% if post.author == current_user %}
                            <div>
                                <form action="{{ url_for('delete_post', post_id=post.id) }}" method="POST" style="display: inline;" onsubmit="return confirm('Are you sure you want to delete this post?');">
                                    <input type="hidden" name="_method" value="DELETE">
                                    <button type="submit" class="btn btn-danger btn-sm">Delete</button>
                                </form>
                            </div>
                        {% endif %}
                    </div>
                    <div class="comments-section mt-3 border-top pt-3" id="comments-section-{{ post.id }}" style="display: none;">
                        <div class="comments-container" id="comments-container-{{ post.id }}">
                            <!-- Comments will be loaded here by AJAX -->
                            <div class="text-center">
                                <div class="spinner-border spinner-border-sm" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </div>
                        </div>
                        <form class="comment-form mt-3" data-post-id="{{ post.id }}">
                            <div class="input-group">
                                <input type="text" class="form-control comment-input" placeholder="Add a comment...">
                                <button class="btn btn-primary" type="submit">Post</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        {% endfor %}
    {% else %}
        <p>No posts found in your feed right now.</p>
    {% endif %}

</div>
{% endblock %}

{% block scripts %}
{{ super() }}
{# Include marked.js first if not already included globally #}
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
{# Include the shared comments script #}
<script src="{{ url_for('static', filename='js/comments.js') }}"></script>
{# Include timestamp formatting script if it exists #}
<script src="{{ url_for('static', filename='js/timestamps.js') }}"></script>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Render markdown for post content (Keep this part)
    console.log('Starting markdown rendering for posts...');
    const postContents = document.querySelectorAll('.post-content');
    console.log(`Found ${postContents.length} post content divs.`);

    postContents.forEach((div, index) => {
      console.log(`Processing post content div #${index+1}:`, div);
      const rawContent = div.getAttribute('data-raw-content');
      // console.log(` Raw post content:`, rawContent); // Reduce console noise

      if (rawContent) {
        try {
            if (typeof marked !== 'undefined') {
                // Configure marked to handle basic GFM line breaks
                marked.setOptions({
                  breaks: true
                });
                // console.log(' Calling marked.parse for post...');
                const htmlContent = marked.parse(rawContent);
                // console.log(` Parsed post HTML:`, htmlContent); 
                // Use innerHTML as marked returns HTML string. Ensure content is properly escaped on server.
                div.innerHTML = htmlContent;
                // console.log(' Post innerHTML set.'); 
            } else {
                console.warn('marked library not found. Cannot render post markdown.');
                 div.textContent = rawContent; // Display raw text as fallback
            }
        } catch (error) {
            console.error('Error parsing post markdown:', error, 'Raw content:', rawContent);
            div.innerHTML = '<p class="text-danger">Error rendering content.</p>'; // Show error in UI
        }
      } else {
        // console.warn(' Raw post content is empty or null for div:', div);
      }
    });
    console.log('Finished markdown rendering for posts.');

    // Comment handling is now initialized by comments.js
    // Timestamps are handled by timestamps.js (and potentially called within comments.js)

    // The initializeCommentHandling() function is called automatically by comments.js
    // when the DOM is ready.

  }); // End DOMContentLoaded
</script>
{% endblock %} 